const db = firebase.firestore();
        const storage = firebase.storage();
        let curUid, pubId, qUnsub;

        firebase.auth().onAuthStateChanged(user => {
            if (!user) { window.location.href = 'login.html'; return; }
            curUid = user.uid;
            db.collection('providers').doc(user.uid).onSnapshot(doc => {
                const data = doc.data();
                if(!data) return;
                pubId = data.googlePlaceId || user.uid;
                document.getElementById('bizTitle').innerText = data.businessName;
                
                const badge = document.getElementById('statusBadge');
                badge.innerHTML = data.isOpen ? 
                    '<span class="status-badge open">● Business is Open</span>' : 
                    '<span class="status-badge closed">● Business is Closed</span>';

                if(data.menuImageUrl) {
                    renderMenuImage(data.menuImageUrl);
                }

                startLiveQ();
                loadServices();
                updateServedToday();
            });
        });

        // --- UI & Navigation ---
        function setInputMode(mode) {
            document.getElementById('form-manual').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('form-upload').style.display = mode === 'upload' ? 'block' : 'none';
            document.getElementById('btnManual').style.background = mode === 'manual' ? '#e2e8f0' : 'white';
            document.getElementById('btnUpload').style.background = mode === 'upload' ? '#e2e8f0' : 'white';
        }

        function showSection(id, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('sec-' + id).style.display = 'block';
            el.classList.add('active');
        }

        // --- Queue Management (SYNCED WITH CUSTOMER TIMER) ---
        function startLiveQ() {
            if(qUnsub) qUnsub();
            
            // Listen for 'waiting' and 'serving' to manage the flow
            qUnsub = db.collection('queues')
                .where('providerId', '==', pubId)
                .where('status', 'in', ['waiting', 'serving'])
                .orderBy('joinedAt', 'asc')
                .onSnapshot(snap => {
                    let totalBacklogMins = 0;
                    let waitingCount = 0;
                    const items = document.getElementById('qItems');
                    items.innerHTML = "";

                    if (snap.empty) {
                        items.innerHTML = '<tr><td colspan="4" style="text-align:center">Queue is empty</td></tr>';
                    }

                    snap.forEach(doc => {
                        const d = doc.data();
                        
                        if (d.status === 'serving') {
                            // Highlight the active customer at the top
                            const row = `
                                <tr style="background: #f0fdf4; border-left: 4px solid #22c55e;">
                                    <td><span class="status-badge open" style="font-size:0.6rem">NOW SERVING</span><br><strong>${d.customerName}</strong></td>
                                    <td>${d.selectedService || '--'}</td>
                                    <td><span style="color:#16a34a; font-weight:bold;">In Progress</span></td>
                                    <td><button class="btn btn-primary" style="background:#16a34a;" onclick="completeService('${doc.id}')">Finish & Complete</button></td>
                                </tr>`;
                            items.innerHTML = row + items.innerHTML;
                        } else {
                            // Count waiting customers and their combined duration
                            waitingCount++;
                            totalBacklogMins += (Number(d.serviceDuration) || 0);
                            
                            items.innerHTML += `
                                <tr>
                                    <td><strong>${d.customerName}</strong><br><small>${d.customerPhone || ''}</small></td>
                                    <td>${d.selectedService || '--'}</td>
                                    <td>${d.serviceDuration || 0}m</td>
                                    <td><button class="btn btn-primary btn-sm" onclick="startServing('${doc.id}')">Start Serving</button></td>
                                </tr>`;
                        }
                    });

                    document.getElementById('waitCount').innerText = waitingCount;
                    document.getElementById('totalMins').innerHTML = totalBacklogMins + '<small style="font-size:1rem">m</small>';
                });
        }

        async function startServing(id) {
            await db.collection('queues').doc(id).update({
                status: 'serving',
                servedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        async function completeService(id) {
            const today = new Date().toISOString().split('T')[0];
            await db.collection('queues').doc(id).update({
                status: 'completed',
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                completedDate: today
            });
            updateServedToday();
        }

        // --- Service Management ---
        async function addSvc() {
            const n = document.getElementById('sName').value;
            const t = document.getElementById('sTime').value;
            const p = document.getElementById('sPrice').value;
            if(!n || !t) return;
            
            await db.collection('providers').doc(curUid).collection('services').add({
                name: n, 
                duration: Number(t), // Forces duration to be a number for the timer
                price: p || 0
            });
            
            document.getElementById('sName').value = ""; 
            document.getElementById('sTime').value = ""; 
            document.getElementById('sPrice').value = "";
        }

        async function updateSvcDuration(id, newTime) {
            await db.collection('providers').doc(curUid).collection('services').doc(id).update({
                duration: Number(newTime)
            });
        }

        async function delSvc(id) { 
            if(confirm("Delete service?")) await db.collection('providers').doc(curUid).collection('services').doc(id).delete(); 
        }

        function loadServices() {
            db.collection('providers').doc(curUid).collection('services').onSnapshot(snap => {
                const list = document.getElementById('svcList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const s = doc.data();
                    list.innerHTML += `<tr>
                        <td><strong>${s.name}</strong></td>
                        <td>$${s.price || 0}</td>
                        <td>
                            <input type="number" class="edit-input" value="${s.duration}" 
                                   onchange="updateSvcDuration('${doc.id}', this.value)">
                            <small>m</small>
                        </td>
                        <td style="text-align: right;">
                            <button class="svc-del" onclick="delSvc('${doc.id}')">×</button>
                        </td>
                    </tr>`;
                });
            });
        }

        // --- Menu Image Storage ---
        async function handleMenuUpload() {
            const file = document.getElementById('menuImgFile').files[0];
            if (!file) return alert("Please select an image file.");
            const uploadBtn = document.querySelector('button[onclick="handleMenuUpload()"]');
            uploadBtn.innerText = "Uploading...";
            uploadBtn.disabled = true;

            try {
                const ref = storage.ref(`menus/${curUid}/price_list`);
                const snapshot = await ref.put(file);
                const url = await snapshot.ref.getDownloadURL();
                await db.collection('providers').doc(curUid).update({ menuImageUrl: url });
                alert("Menu image saved!");
                renderMenuImage(url);
            } catch (error) {
                alert("Upload failed. Verify Storage is enabled in Firebase Console.");
            } finally {
                uploadBtn.innerText = "Save Menu Image";
                uploadBtn.disabled = false;
            }
        }

        function renderMenuImage(url) {
            const area = document.getElementById('menuImageArea');
            area.innerHTML = `<img src="${url}" id="menuPreviewImg">`;
        }

        // --- Extras & Auth ---
        async function toggleStatus() {
            const ref = db.collection('providers').doc(curUid);
            const snap = await ref.get();
            await ref.update({ isOpen: !snap.data().isOpen });
        }

        function toggleQR() {
            const overlay = document.getElementById('qrOverlay');
            if(overlay.style.display === 'flex') { overlay.style.display = 'none'; } 
            else {
                overlay.style.display = 'flex';
                const box = document.getElementById('qrcode-box');
                box.innerHTML = "";
                const url = `https://zerowait-c21fc.web.app/join-queue.html?id=${pubId}`;
                new QRCode(box, { text: url, width: 250, height: 250 });
            }
        }

        async function updateServedToday() {
            const today = new Date().toISOString().split('T')[0];
            const snap = await db.collection('queues').where('providerId','==',pubId).where('status','==','completed').where('completedDate','==',today).get();
            document.getElementById('servedToday').innerText = snap.size;
        }

        function handleLogout() { firebase.auth().signOut().then(() => window.location.href='index.html'); }
