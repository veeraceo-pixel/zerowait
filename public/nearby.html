<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nearby Discovery | skipQs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg-light: #f8fafc; --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0; --accent: #764ba2; --success: #059669; --nav-bg: #2d1b4d; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }

        /* Header & Navigation */
        .navbar { background: var(--nav-bg); padding: 0.6rem 0; z-index: 1000; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .nav-top { display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; margin-bottom: 8px; }
        .logo { font-weight: 800; color: white; text-decoration: none; font-size: 1.2rem; }
        
        .search-area { width: 95%; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 8px; }
        #location-search { width: 100%; padding: 12px 20px; border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 0.9rem; font-weight: 500; outline: none; }
        
        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding: 2px 0 8px 0; scrollbar-width: none; }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { padding: 8px 16px; background: rgba(255,255,255,0.15); color: white; border-radius: 20px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .filter-chip.active { background: white; color: var(--nav-bg); transform: scale(1.05); }

        /* Split View Layout */
        .split-view { display: flex; flex-direction: column; height: calc(100vh - 125px); width: 100%; }
        #map { flex: 1; min-height: 35%; background: #e5e7eb; }
        .list-panel { flex: 2; background: white; border-top: 1px solid var(--border); overflow-y: auto; padding: 1rem; -webkit-overflow-scrolling: touch; }

        /* Place Cards */
        .place-card { padding: 1rem; margin-bottom: 0.8rem; border: 1px solid var(--border); border-radius: 16px; background: white; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .place-card:active { transform: scale(0.98); background: #f1f5f9; }
        .card-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; background: #eee; }
        .card-meta { font-size: 0.7rem; font-weight: 700; color: var(--primary); margin-top: 4px; }
        .btn-explore { background: var(--primary); color: white; border: none; border-radius: 8px; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; margin-top: 6px; width: fit-content; }

        /* IMMERSIVE STREET VIEW MODE */
        #street-view-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: black; }
        .close-street-view { position: absolute; top: 20px; right: 20px; z-index: 5002; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        
        #immersive-scroller { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; overflow-x: auto; padding: 0 20px; gap: 15px; scroll-snap-type: x mandatory; z-index: 5001; scrollbar-width: none; }
        #immersive-scroller::-webkit-scrollbar { display: none; }

        .shop-card-immersive { min-width: 310px; background: white; border-radius: 24px; padding: 18px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); scroll-snap-align: center; border-bottom: 6px solid var(--primary); }
        .hud-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .hud-status { padding: 4px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: 800; background: #f1f5f9; color: var(--text-muted); }
        .hud-status.partner { background: #d1fae5; color: #065f46; }
        .btn-join-immersive { width: 100%; background: var(--success); color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 700; font-size: 0.9rem; margin-top: 10px; cursor: pointer; }

        @media (min-width: 769px) {
            .split-view { flex-direction: row; }
            #map { flex: 1.6; height: 100%; }
            .list-panel { width: 420px; flex: none; border-top: none; border-left: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-top">
            <a href="index.html" class="logo">skipQs</a>
            <div id="auth-section">
                <a href="dashboard.html" style="color:white; text-decoration:none; font-size:0.8rem; font-weight:600; margin-right:15px;">My Visits</a>
                <button id="authBtn" style="background:rgba(255,255,255,0.2); color:white; border:none; padding:6px 14px; border-radius:8px; font-weight:700; cursor:pointer;">Login</button>
            </div>
        </div>
        <div class="search-area">
            <input id="location-search" type="text" placeholder="Search a street, shop, or city...">
            <div class="filter-bar">
                <div class="filter-chip active" data-type="salon">‚úÇÔ∏è Salons</div>
                <div class="filter-chip" data-type="restaurant">üçï Restaurants</div>
                <div class="filter-chip" data-type="clinic">üè• Health</div>
                <div class="filter-chip" data-type="hotel">üè® Hotels</div>
            </div>
        </div>
    </nav>

    <div class="split-view">
        <div id="map"></div>
        <div class="list-panel" id="results">
            <p style="text-align:center; color:gray; padding:20px;">Finding services near you...</p>
        </div>
    </div>

    <div id="street-view-container">
        <button class="close-street-view" onclick="closeStreetView()">‚úï</button>
        <div id="street-pano" style="width: 100%; height: 100%;"></div>
        <div id="immersive-scroller"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();
        let serviceType = 'salon';
        let map, placesService, userLocation, autocomplete, pano;
        let allResults = [];

        // 1. Auth & Login Logic
        firebase.auth().onAuthStateChanged((user) => {
            const btn = document.getElementById('authBtn');
            if (user) {
                btn.innerText = "Logout";
                btn.onclick = () => firebase.auth().signOut().then(() => location.reload());
            } else {
                btn.innerText = "Login";
                btn.onclick = () => window.location.href = 'login.html';
            }
        });

        // 2. Initialize Google Maps & Autocomplete
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 53.4875, lng: -2.2901 }, zoom: 14, disableDefaultUI: true,
                styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
            });
            placesService = new google.maps.places.PlacesService(map);
            
            const input = document.getElementById("location-search");
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                userLocation = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                map.setCenter(userLocation);
                searchNearby();
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setCenter(userLocation);
                    searchNearby();
                }, () => { 
                    userLocation = map.getCenter().toJSON(); 
                    searchNearby(); 
                });
            }
        }

        // 3. Category Filter Logic
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.onclick = function() {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                serviceType = this.dataset.type;
                searchNearby();
            }
        });

        // 4. Core Search Logic
        function searchNearby() {
            const queryMap = { salon: "hair salon barber beauty", restaurant: "restaurant cafe food", clinic: "medical health center", hotel: "hotel lodging" };
            placesService.nearbySearch({
                location: userLocation, radius: 4000, keyword: queryMap[serviceType]
            }, (results, status) => {
                if (status === "OK") {
                    allResults = results;
                    renderListView(results);
                }
            });
        }

        // 5. Render List Panel
        function renderListView(results) {
            const container = document.getElementById("results");
            container.innerHTML = `<h3 style="margin:0 0 12px 0; font-weight:800;">Nearby ${serviceType.charAt(0).toUpperCase() + serviceType.slice(1)}s</h3>`;
            
            results.forEach((place, index) => {
                const photo = place.photos ? place.photos[0].getUrl({maxWidth: 200}) : 'https://via.placeholder.com/150';
                const dist = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userLocation.lat, userLocation.lng), place.geometry.location);
                const miles = (dist * 0.000621371).toFixed(1);

                const card = document.createElement('div');
                card.className = 'place-card';
                card.innerHTML = `
                    <img src="${photo}" class="card-img">
                    <div style="flex:1">
                        <div style="font-weight:800; font-size:0.95rem; color:var(--text-main); line-height:1.2;">${place.name}</div>
                        <div class="card-meta">üìç ${miles} miles away</div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-top:2px;">${place.vicinity}</div>
                        <button class="btn-explore" onclick="event.stopPropagation(); openStreetView(${index})">üö∂ Walk the street</button>
                    </div>
                    <div style="font-weight:800; color:#f59e0b; font-size:0.8rem;">‚òÖ ${place.rating || 'N/A'}</div>
                `;
                card.onclick = () => { map.panTo(place.geometry.location); map.setZoom(17); };
                container.appendChild(card);
            });
        }

        // 6. Immersive Street View Logic
        function openStreetView(index) {
            const place = allResults[index];
            document.getElementById('street-view-container').style.display = 'block';
            
            pano = new google.maps.StreetViewPanorama(document.getElementById("street-pano"), {
                position: place.geometry.location,
                pov: { heading: 160, pitch: 0 },
                zoom: 1, addressControl: false, disableDefaultUI: true, clickToGo: true
            });

            renderImmersiveCards(index);
        }

        function renderImmersiveCards(activeIndex) {
            const scroller = document.getElementById('immersive-scroller');
            scroller.innerHTML = "";
            
            allResults.forEach((place, i) => {
                const card = document.createElement('div');
                card.className = 'shop-card-immersive';
                card.id = `imm-card-${i}`;
                card.innerHTML = `
                    <div class="hud-row">
                        <div style="font-weight:800; font-size:1.1rem; max-width:70%;">${place.name}</div>
                        <div class="hud-status" id="stat-${i}">Checking...</div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">${place.vicinity}</div>
                    <div id="q-area-${i}" style="display:none">
                        <div style="background:#f8fafc; padding:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:0.85rem; font-weight:600;">Current Queue:</span>
                            <span style="font-weight:800; color:var(--primary); font-size:1.1rem;" id="cnt-${i}">0</span>
                        </div>
                        <button class="btn-join-immersive" onclick="joinQueue('${place.place_id}', '${place.name.replace(/'/g, "\\'")}')">JOIN THE QUEUE</button>
                    </div>
                    <div id="off-area-${i}" style="font-size:0.75rem; color:var(--text-muted); font-weight:500; text-align:center; padding:10px;">Not integrated with skipQs yet</div>
                `;
                
                card.onclick = () => {
                    pano.setPosition(place.geometry.location);
                    card.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                };

                scroller.appendChild(card);

                // Fetch Firebase Data for each card
                db.collection('providers').where('googlePlaceId', '==', place.place_id).get().then(snap => {
                    const statusBadge = document.getElementById(`stat-${i}`);
                    if (!snap.empty) {
                        const d = snap.docs[0].data();
                        statusBadge.innerText = "‚úì skipQs PARTNER";
                        statusBadge.className = "hud-status partner";
                        document.getElementById(`cnt-${i}`).innerText = d.queueCount || 0;
                        document.getElementById(`q-area-${i}`).style.display = "block";
                        document.getElementById(`off-area-${i}`).style.display = "none";
                    }
                });
            });

            // Smooth scroll to the one clicked
            setTimeout(() => {
                const activeCard = document.getElementById(`imm-card-${activeIndex}`);
                if(activeCard) activeCard.scrollIntoView({ inline: 'center', behavior: 'smooth' });
            }, 500);
        }

        function joinQueue(pid, name) {
            db.collection('providers').where('googlePlaceId', '==', pid).get().then(snap => {
                if(!snap.empty) {
                    window.location.href=`join-queue.html?id=${snap.docs[0].id}&name=${encodeURIComponent(name)}`;
                }
            });
        }

        function closeStreetView() {
            document.getElementById('street-view-container').style.display = 'none';
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJFGE5OFfn-OhDNJ_rWO5oi2d2CHl2fXE&libraries=places,geometry&callback=initMap" async defer></script>
</body>
</html>
