<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nearby Discovery | skipQs</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #2563eb; --bg-light: #f8fafc; --text-main: #1e293b; 
            --text-muted: #64748b; --border: #e2e8f0; --accent: #f59e0b; 
            --success: #10b981; --nav-bg: #0f172a; --white: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }

        /* Navigation & Filters */
        .navbar { background: var(--nav-bg); padding: 0.75rem 0; z-index: 1000; position: relative; }
        .nav-top { display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; margin-bottom: 10px; }
        .logo { font-weight: 800; color: white; text-decoration: none; font-size: 1.4rem; letter-spacing: -1px; }
        
        .search-area { width: 95%; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        #location-search { 
            width: 100%; padding: 14px 20px; border-radius: 12px; border: none; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.95rem; font-weight: 500; outline: none; 
        }
        
        .filter-bar { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0 10px 0; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { 
            padding: 8px 18px; background: rgba(255,255,255,0.1); color: white; 
            border-radius: 20px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; 
            cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; transform: translateY(-2px); }

        /* Split View Layout */
        .split-view { display: flex; flex-direction: column; height: calc(100vh - 145px); width: 100%; }
        #map { flex: 1; min-height: 30%; background: #e5e7eb; }
        .list-panel { flex: 2; background: white; border-top: 1px solid var(--border); overflow-y: auto; padding: 1.2rem; -webkit-overflow-scrolling: touch; }

        /* Place Cards */
        .place-card { 
            padding: 1.2rem; margin-bottom: 1rem; border: 1px solid var(--border); 
            border-radius: 20px; background: white; display: flex; flex-direction: column; 
            gap: 12px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .card-main { display: flex; gap: 15px; align-items: flex-start; }
        .card-img { width: 85px; height: 85px; border-radius: 14px; object-fit: cover; background: #f1f5f9; flex-shrink: 0; }
        
        .wait-badge { 
            display: inline-flex; align-items: center; gap: 5px; 
            padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 800; 
        }
        .wait-low { background: #d1fae5; color: #065f46; }
        .wait-med { background: #fef3c7; color: #92400e; }
        .wait-high { background: #fee2e2; color: #991b1b; }

        .btn-group { display: flex; gap: 8px; margin-top: 5px; }
        .btn-action { 
            flex: 1; padding: 10px; border-radius: 10px; font-size: 0.8rem; 
            font-weight: 700; cursor: pointer; border: none; transition: 0.2s;
            text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--bg-light); color: var(--text-main); border: 1px solid var(--border); }
        .btn-claim { background: #eff6ff; color: var(--primary); border: 1.5px dashed var(--primary); width: 100%; }

        /* Street View Overlay */
        #street-view-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: black; }
        .close-street-view { position: absolute; top: 20px; right: 20px; z-index: 5002; background: white; color: black; border: none; border-radius: 50%; width: 40px; height: 40px; font-weight: bold; cursor: pointer; }

        @media (min-width: 769px) {
            .split-view { flex-direction: row; }
            #map { flex: 1.5; height: 100%; }
            .list-panel { width: 450px; flex: none; border-top: none; border-left: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-top">
            <a href="index.html" class="logo">skipQs</a>
            <div id="auth-section">
                <button id="authBtn" style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:10px; font-weight:700; cursor:pointer;">Login</button>
            </div>
        </div>
        <div class="search-area">
            <input id="location-search" type="text" placeholder="Enter city or street...">
            <div class="filter-bar" id="categoryFilters">
                <div class="filter-chip active" data-type="salon">üíá‚Äç‚ôÄÔ∏è Salons</div>
                <div class="filter-chip" data-type="dining">üçΩÔ∏è Dining</div>
                <div class="filter-chip" data-type="clinic">üè• Clinics</div>
                <div class="filter-chip" data-type="banking">üè¶ Banking</div>
                <div class="filter-chip" data-type="gym">üèãÔ∏è Gyms</div>
                <div class="filter-chip" data-type="repair">üõ†Ô∏è Repairs</div>
                <div class="filter-chip" data-type="gov">üèõÔ∏è Gov</div>
                <div class="filter-chip" data-type="wash">üßº Wash</div>
            </div>
        </div>
    </nav>

    <div class="split-view">
        <div id="map"></div>
        <div class="list-panel" id="results">
            <div style="text-align:center; margin-top:50px;">
                <p style="color:var(--text-muted);">Finding the best spots near you...</p>
            </div>
        </div>
    </div>

    <div id="street-view-container">
        <button class="close-street-view" onclick="closeStreetView()">‚úï</button>
        <div id="street-pano" style="width: 100%; height: 100%;"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();
        
        // Comprehensive Synonym Map
        const categoryKeywords = {
            salon: "hair salon barber beauty parlour nail cut haircut waxing",
            dining: "restaurant cafe food bistro pizza burger dining",
            clinic: "medical clinic doctor health center dentist hospital pharmacy",
            banking: "bank atm financial services credit union",
            gym: "gym fitness center workout yoga studio crossfit",
            repair: "auto repair mechanic electronics repair handyman phone repair plumber",
            gov: "government office post office town hall embassy court",
            wash: "car wash laundry dry cleaning laundromat"
        };

        let serviceType = 'salon';
        let map, placesService, userLocation, autocomplete;
        let allResults = [];

        // Auth Logic
        firebase.auth().onAuthStateChanged(user => {
            const btn = document.getElementById('authBtn');
            if (user) {
                btn.innerText = "Logout";
                btn.onclick = () => firebase.auth().signOut().then(() => location.reload());
            } else {
                btn.innerText = "Login";
                btn.onclick = () => window.location.href = 'login.html';
            }
        });

        function initMap() {
            // 1. Handle incoming URL parameters (e.g., ?type=gym)
            const urlParams = new URLSearchParams(window.location.search);
            const typeParam = urlParams.get('type');
            if (typeParam && categoryKeywords[typeParam]) {
                serviceType = typeParam;
                document.querySelectorAll('.filter-chip').forEach(c => {
                    c.classList.toggle('active', c.dataset.type === typeParam);
                });
            }

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 53.4808, lng: -2.2426 }, zoom: 14, 
                disableDefaultUI: true, zoomControl: true,
                styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
            });
            
            placesService = new google.maps.places.PlacesService(map);
            setupLocationSearch();
            detectUserLocation();
        }

        function setupLocationSearch() {
            const input = document.getElementById("location-search");
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                userLocation = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                map.panTo(userLocation);
                searchNearby();
            });
        }

        function detectUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setCenter(userLocation);
                    searchNearby();
                }, () => fallbackSearch());
            } else { fallbackSearch(); }
        }

        function fallbackSearch() {
            userLocation = map.getCenter().toJSON();
            searchNearby();
        }

        // Chip Click Logic
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.onclick = function() {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                serviceType = this.dataset.type;
                searchNearby();
            }
        });

        function searchNearby() {
            const keywords = categoryKeywords[serviceType];
            placesService.nearbySearch({
                location: userLocation, radius: 5000, keyword: keywords
            }, (results, status) => {
                if (status === "OK") {
                    allResults = results;
                    renderListView(results);
                }
            });
        }

        function renderListView(results) {
            const container = document.getElementById("results");
            container.innerHTML = `<h3 style="font-weight:800; margin-bottom:1.2rem; letter-spacing:-0.5px;">${serviceType.charAt(0).toUpperCase() + serviceType.slice(1)}s Near You</h3>`;

            results.forEach((place, index) => {
                const photo = place.photos ? place.photos[0].getUrl({maxWidth: 300}) : 'https://images.unsplash.com/photo-1521590832167-7bcbfaa6381f?auto=format&fit=crop&w=300&q=80';
                
                const distMeters = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(userLocation.lat, userLocation.lng), 
                    place.geometry.location
                );
                const miles = (distMeters * 0.000621371).toFixed(1);

                const card = document.createElement('div');
                card.className = 'place-card';
                card.innerHTML = `
                    <div class="card-main">
                        <img src="${photo}" class="card-img">
                        <div style="flex:1">
                            <div style="font-weight:800; font-size:1.05rem; line-height:1.2;">${place.name}</div>
                            <div style="font-size:0.75rem; font-weight:600; color:var(--text-muted); margin: 4px 0;">
                                üìç ${miles} miles away ‚Ä¢ ‚òÖ ${place.rating || 'N/A'}
                            </div>
                            <div id="status-container-${index}" style="margin-top:8px;">
                                <div style="font-size:0.7rem; color:var(--text-muted);">Syncing live queue...</div>
                            </div>
                        </div>
                    </div>
                    <div id="action-container-${index}" class="btn-group">
                         <button class="btn-action btn-secondary" onclick="openStreetView(${index})">Street View</button>
                    </div>
                `;
                container.appendChild(card);

                // Firebase Data Sync
                db.collection('providers').where('googlePlaceId', '==', place.place_id).get().then(snap => {
                    const statusDiv = document.getElementById(`status-container-${index}`);
                    const actionDiv = document.getElementById(`action-container-${index}`);

                    if (!snap.empty) {
                        const d = snap.docs[0].data();
                        const count = d.queueCount || 0;
                        const waitPerPerson = d.avgWaitTime || 12;
                        const totalWait = count * waitPerPerson;

                        let statusClass = "wait-low"; let label = "Fast";
                        if(count > 8) { statusClass = "wait-high"; label = "Busy"; }
                        else if(count > 4) { statusClass = "wait-med"; label = "Moderate"; }

                        statusDiv.innerHTML = `
                            <div class="wait-badge ${statusClass}">‚óè ${label}</div>
                            <div style="margin-top:5px; font-weight:700; font-size:0.85rem; color:var(--primary);">
                                ${totalWait} min wait <span style="color:var(--text-muted); font-weight:500;">(${count} ahead)</span>
                            </div>
                        `;
                        
                        actionDiv.innerHTML += `
                            <button class="btn-action btn-primary" onclick="joinQueue('${snap.docs[0].id}', '${place.name.replace(/'/g, "\\'")}')">Join Queue</button>
                        `;
                    } else {
                        statusDiv.innerHTML = `<div style="font-size:0.7rem; color:var(--text-muted);">Not on skipQs yet</div>`;
                        actionDiv.innerHTML += `
                            <a href="business-signup.html" class="btn-action btn-claim">Is this yours? Claim Free</a>
                        `;
                    }
                });
            });
        }

        function openStreetView(index) {
            const place = allResults[index];
            document.getElementById('street-view-container').style.display = 'block';
            new google.maps.StreetViewPanorama(document.getElementById("street-pano"), {
                position: place.geometry.location, pov: { heading: 165, pitch: 0 }, zoom: 1, addressControl: false
            });
        }

        function closeStreetView() { document.getElementById('street-view-container').style.display = 'none'; }

        function joinQueue(docId, name) {
            window.location.href = `join-queue.html?id=${docId}&name=${encodeURIComponent(name)}`;
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJFGE5OFfn-OhDNJ_rWO5oi2d2CHl2fXE&libraries=places,geometry&callback=initMap" async defer></script>
</body>
</html>
