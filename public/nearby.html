<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find Nearby Services | skipQs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --bg-light: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --accent: #764ba2;
            --success: #059669;
            --nav-bg: #2d1b4d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }

        /* Consistent Navbar */
        .navbar { background: var(--nav-bg); padding: 0.75rem 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); position: relative; z-index: 1000; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.25rem; color: white; text-decoration: none; letter-spacing: -0.5px; }

        .split-view { display: flex; flex-direction: column; height: calc(100vh - 58px); width: 100%; }
        #map { flex: 1; min-height: 35%; background: #e5e7eb; }
        .list-panel { flex: 2; background: white; border-top: 1px solid var(--border); overflow-y: auto; padding: 1rem; -webkit-overflow-scrolling: touch; }

        .place-card { 
            padding: 1rem; margin-bottom: 0.75rem; border: 1px solid var(--border); border-radius: 12px; 
            background: white; cursor: pointer; display: flex; align-items: flex-start; transition: 0.1s;
        }
        .place-card:hover { border-color: var(--primary); background: #fafafa; }
        
        .card-number {
            background: var(--accent); color: white; width: 22px; height: 22px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; margin-right: 10px; flex-shrink: 0;
        }
        .card-info { flex: 1; }
        .dist-text { font-size: 0.75rem; font-weight: 700; color: var(--primary); margin-top: 2px; }
        .rating-badge { background: #fffbeb; color: #92400e; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; border: 1px solid #fde68a; }
        
        .provider-status { padding: 0.3rem 0.5rem; border-radius: 6px; font-size: 0.65rem; font-weight: 700; margin-top: 0.5rem; display: inline-block; }
        .provider-registered { background: #d1fae5; color: #065f46; }
        .provider-not-registered { background: #f1f5f9; color: #64748b; }

        #detailModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 1.5rem 1.5rem 0 0; overflow: hidden; position: relative; animation: slideUp 0.2s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .photo-gallery { display: flex; overflow-x: auto; height: 180px; background: #eee; scroll-snap-type: x mandatory; }
        .photo-gallery img { height: 100%; object-fit: cover; min-width: 100%; scroll-snap-align: start; }
        .modal-body { padding: 1.25rem; overflow-y: auto; flex: 1; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 1rem; }
        .btn-join { flex: 2; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; font-size: 0.9rem; }
        .btn-offline { background: #64748b !important; cursor: not-allowed; }
        .btn-maps { flex: 1; padding: 1rem; background: #f1f5f9; color: var(--text-main); border: 1px solid var(--border); border-radius: 0.75rem; font-weight: 600; text-decoration: none; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; }
        
        .travel-info { margin-top: 8px; font-size: 0.85rem; color: var(--success); font-weight: 700; display: flex; align-items: center; gap: 5px; }

        @media (min-width: 769px) {
            .split-view { flex-direction: row; }
            #map { flex: 1.6; height: 100%; }
            .list-panel { width: 450px; flex: none; border-top: none; border-left: 1px solid var(--border); }
            #detailModal { align-items: center; padding: 20px; }
            .modal-content { border-radius: 1.25rem; max-height: 85vh; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">skipQs</a>
            <div>
                <a href="dashboard.html" id="myVisitsLink" style="color:white; text-decoration:none; font-size:0.85rem; font-weight:600; margin-right:10px;">My Visits</a>
                <a href="login.html" id="authBtn" style="color:white; text-decoration:none; font-size:0.85rem; font-weight:600; padding: 6px 12px; border-radius:6px; background: rgba(255,255,255,0.2);">Login</a>
            </div>
        </div>
    </nav>

    <div class="split-view">
        <div id="map"></div>
        <div class="list-panel">
            <header style="margin-bottom: 1rem;">
                <h2 id="title" style="margin: 0; font-weight: 800; font-size: 1.25rem;">Nearby Services</h2>
                <p id="status-text" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Detecting location...</p>
            </header>
            <div id="results"></div>
        </div>
    </div>

    <div id="detailModal">
        <div class="modal-content">
            <button onclick="closeModal()" style="position:absolute; right:12px; top:12px; border:none; background:rgba(0,0,0,0.5); color:white; border-radius:50%; width:30px; height:30px; cursor:pointer; font-weight:bold; z-index:100;">‚úï</button>
            <div id="modalPhotos" class="photo-gallery"></div>
            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h3 id="modalName" style="margin:0; font-weight:800; font-size:1.25rem; line-height:1.2; max-width: 80%;"></h3>
                    <div id="modalRating" class="rating-badge"></div>
                </div>
                <div id="modalAddressContainer" style="margin-top: 5px;">
                    <p id="modalAddress" style="font-size:0.8rem; color:var(--text-muted); margin: 0;"></p>
                    <div id="modalDistance" style="font-size: 0.8rem; color: var(--primary); font-weight: 700; margin-top: 2px;"></div>
                </div>
                <div id="modalTravelTime" class="travel-info"></div>
                <div id="modalReviews" style="font-size: 0.8rem; border-top: 1px solid #f1f5f9; padding-top: 1rem; margin-top: 10px;"></div>
                <div id="modalAction"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();
        const params = new URLSearchParams(window.location.search);
        let serviceType = params.get("type") || 'salon';
        
        const SERVICE_MAP = {
            salon: { type: "hair_care", keyword: "salon", label: "Salons Nearby" },
            restaurant: { type: "restaurant", keyword: "restaurant", label: "Restaurants Nearby" },
            clinic: { type: "hospital", keyword: "clinic", label: "Clinics Nearby" }
        };

        const config = SERVICE_MAP[serviceType] || SERVICE_MAP.salon;
        document.getElementById("title").innerText = config.label;

        let map, placesService, userLocation;
        let markers = [];
        const defaultLocation = { lat: 53.4875, lng: -2.2901 }; 

        // Login status listener
        firebase.auth().onAuthStateChanged((user) => {
            const authBtn = document.getElementById('authBtn');
            const myVisits = document.getElementById('myVisitsLink');
            if (user) {
                authBtn.innerText = "Logout";
                authBtn.onclick = (e) => {
                    e.preventDefault();
                    firebase.auth().signOut().then(() => location.reload());
                };
            } else {
                authBtn.innerText = "Login";
                myVisits.style.display = 'none';
            }
        });

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation, zoom: 14, 
                mapTypeControl: false, streetViewControl: false
            });
            placesService = new google.maps.places.PlacesService(map);
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setCenter(userLocation);
                    searchNearby();
                }, () => { 
                    userLocation = defaultLocation;
                    searchNearby(); 
                }, { timeout: 10000, enableHighAccuracy: true });
            } else {
                userLocation = defaultLocation;
                searchNearby();
            }
        }

        function searchNearby() {
            userLocation = userLocation || defaultLocation;
            document.getElementById("status-text").innerText = "Finding " + serviceType + "s...";
            
            placesService.nearbySearch({
                location: userLocation, radius: 5000, 
                type: config.type, keyword: config.keyword
            }, (results, status) => {
                if (status === "OK") {
                    results.forEach(p => {
                        p.distMeters = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(userLocation.lat, userLocation.lng),
                            p.geometry.location
                        );
                    });
                    results.sort((a, b) => a.distMeters - b.distMeters);
                    renderResults(results);
                    document.getElementById("status-text").innerText = results.length + " locations found near you.";
                } else {
                    document.getElementById("results").innerHTML = "<p style='text-align:center; padding:2rem;'>No results found.</p>";
                }
            });
        }

        function renderResults(results) {
            const container = document.getElementById("results");
            container.innerHTML = "";
            markers.forEach(m => m.setMap(null));
            markers = [];

            results.forEach((place, index) => {
                const miles = (place.distMeters * 0.000621371).toFixed(1);
                const marker = new google.maps.Marker({ 
                    map, position: place.geometry.location, 
                    label: { text: (index + 1).toString(), color: 'white', fontSize: '10px', fontWeight: 'bold' } 
                });
                markers.push(marker);

                const card = document.createElement('div');
                card.className = 'place-card';
                card.innerHTML = `
                    <div class="card-number">${index + 1}</div>
                    <div class="card-info">
                        <strong>${place.name}</strong>
                        <span style="font-size:0.75rem; color:var(--text-muted)">${place.vicinity}</span>
                        <div class="dist-text">üìç ${miles} miles away</div>
                        <span id="st-${index}" class="provider-status" style="background:#eee;">Checking skipQs...</span>
                    </div>
                    <span class="rating-badge">‚òÖ ${place.rating || "N/A"}</span>
                `;
                card.onclick = () => openDetails(place, index);
                container.appendChild(card);

                db.collection('providers').where('googlePlaceId', '==', place.place_id).get().then(snap => {
                    const badge = document.getElementById(`st-${index}`);
                    if (!badge) return;
                    badge.innerText = snap.empty ? "Not on skipQs yet" : "‚úì skipQs Partner";
                    badge.className = "provider-status " + (snap.empty ? "provider-not-registered" : "provider-registered");
                    badge.style.background = "";
                });
            });
        }

        function calculateTravelTime(destLocation) {
            const service = new google.maps.DistanceMatrixService();
            const timeDisplay = document.getElementById('modalTravelTime');

            service.getDistanceMatrix({
                origins: [userLocation],
                destinations: [destLocation],
                travelMode: 'DRIVING',
            }, (response, status) => {
                if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                    const durationText = response.rows[0].elements[0].duration.text;
                    timeDisplay.innerHTML = `üöó <b>${durationText}</b> drive from your location`;
                } else {
                    timeDisplay.innerHTML = ""; 
                }
            });
        }

        function openDetails(place, index) {
            const placeId = place.place_id;
            const miles = (place.distMeters * 0.000621371).toFixed(1);

            document.getElementById('detailModal').style.display = 'flex';
            document.getElementById('modalName').innerText = place.name;
            document.getElementById('modalAddress').innerText = place.vicinity;
            document.getElementById('modalDistance').innerText = `üìç ${miles} miles away`;
            document.getElementById('modalTravelTime').innerHTML = "<span style='color:#94a3b8; font-weight:400; font-size:0.8rem;'>Calculating travel time...</span>";
            document.getElementById('modalPhotos').innerHTML = "<div style='padding:40px; text-align:center; width:100%;'>Loading photos...</div>";
            document.getElementById('modalReviews').innerHTML = "";

            if (userLocation) calculateTravelTime(place.geometry.location);

            placesService.getDetails({ placeId, fields: ['photos', 'reviews', 'rating', 'url'] }, (placeDetails, status) => {
                if (status === "OK") {
                    document.getElementById('modalRating').innerText = "‚òÖ " + (placeDetails.rating || "N/A");
                    if (placeDetails.photos) {
                        document.getElementById('modalPhotos').innerHTML = placeDetails.photos.slice(0, 5).map(p => `<img src="${p.getUrl()}">`).join('');
                    }
                    if (placeDetails.reviews && placeDetails.reviews.length > 0) {
                        document.getElementById('modalReviews').innerHTML = `<b>Top Review:</b><p style="margin:5px 0;">"${placeDetails.reviews[0].text.substring(0,120)}..."</p>`;
                    }

                    db.collection('providers').where('googlePlaceId', '==', placeId).get().then(snap => {
                        const actionDiv = document.getElementById('modalAction');
                        const mapUrl = placeDetails.url || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${placeId}`;
                        
                        let html = `<div class="btn-group">
                            <a href="${mapUrl}" target="_blank" class="btn-maps">üìç Directions</a>`;
                        
                        if (!snap.empty) {
                            const providerDoc = snap.docs[0];
                            const providerData = providerDoc.data();
                            // Pass the actual Firestore Document ID to the join-queue page
                            const firestoreId = providerDoc.id;

                            if (providerData.status === 'closed' || providerData.active === false) {
                                html += `<button class="btn-join btn-offline">QUEUE OFFLINE</button>`;
                            } else {
                                html += `<button class="btn-join" onclick="window.location.href='join-queue.html?id=${firestoreId}&name=${encodeURIComponent(place.name)}'">JOIN QUEUE</button>`;
                            }
                        } else {
                            html += `<button class="btn-join btn-offline">Queue Offline</button>`;
                        }
                        html += `</div>`;
                        
                        if (snap.empty) {
                            html += `<a href="provider-signup.html" style="display:block; text-align:center; margin-top:1rem; font-size:0.8rem; color:var(--primary); font-weight:600; text-decoration:none;">Business Owner? Register here</a>`;
                        }
                        actionDiv.innerHTML = html;
                    });
                }
            });
        }

        function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAG-Qv4aH4xE2VFAMImB_xwG4J8TmehUMQ&libraries=places,geometry&callback=initMap" async defer></script>
</body>
</html>
