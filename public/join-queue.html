<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Join Queue | skipQs</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --nav-bg: #2d1b4d; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        .navbar { background: var(--nav-bg); padding: 1rem 0; color: white; text-align: center; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-container { max-width: 800px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.5rem; color: white; text-decoration: none; letter-spacing: -0.5px; }
        .nav-links a { color: white; text-decoration: none; font-size: 0.9rem; margin-left: 15px; font-weight: 600; }

        .content-area { display: flex; align-items: flex-start; justify-content: center; min-height: calc(100vh - 80px); padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 450px; text-align: center; }
        
        .wait-preview { background: #eff6ff; padding: 1rem; border-radius: 1rem; margin-bottom: 1.5rem; display: flex; justify-content: space-around; }
        .stat { display: block; font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 600; }

        .svc-container { text-align: left; margin: 1.5rem 0; border: 1px solid #e2e8f0; border-radius: 0.8rem; overflow: hidden; }
        .svc-item { display: flex; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .svc-item:last-child { border-bottom: none; }
        .svc-item:hover { background: #f8fafc; }
        .svc-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        .svc-info { flex: 1; }
        .svc-name { display: block; font-weight: 600; font-size: 0.95rem; color: #1e293b; }
        .svc-meta { font-size: 0.75rem; color: #64748b; }
        
        input[type="text"], input[type="tel"] { width: 100%; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box; margin-top: 0.8rem; outline: none; }
        
        .btn { width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; font-weight: 700; cursor: pointer; margin-top: 1.2rem; transition: 0.3s; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        #menuImgPreview { width: 100%; border-radius: 0.8rem; margin-top: 1rem; display: none; border: 1px solid #e2e8f0; }
        
        .hidden { display: none; }
        .error-state { color: #dc2626; padding: 1rem; background: #fee2e2; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">skipQs</a>
            <div class="nav-links">
                <a href="index.html#categories">Find Services</a>
                <a href="login.html" id="authBtn">Login</a>
            </div>
        </div>
    </nav>

    <div class="content-area">
        <div class="card">
            <h2 id="bizName" style="margin-bottom: 0.5rem; color: #1e293b;">Loading...</h2>
            <img id="menuImgPreview" src="" alt="Business Menu">

            <div id="errorMessage" class="hidden error-state"></div>

            <div id="joinSection">
                <div class="wait-preview">
                    <div><span class="label">People Ahead</span><span class="stat" id="aheadCount">0</span></div>
                    <div><span class="label">Your Wait</span><span class="stat" id="estWait">0</span><span class="label">mins</span></div>
                </div>

                <p style="text-align: left; font-weight: 700; font-size: 0.9rem; margin-bottom: -10px; color: #475569;">Select Services:</p>
                <div id="serviceChecklist" class="svc-container">
                    <p style="padding: 1rem; color: #94a3b8; font-size: 0.8rem;">Loading services...</p>
                </div>

                <input type="text" id="custName" placeholder="Your Name" required>
                <input type="tel" id="custPhone" placeholder="Mobile Number" required>
                <button onclick="handleCustomerJoin()" id="joinBtn" class="btn">Confirm & Join Queue</button>
            </div>

            <div id="statusSection" class="hidden">
                <div style="background: #dcfce7; color: #166534; padding: 0.4rem; border-radius: 2rem; font-size: 0.8rem; font-weight: bold; margin-bottom: 1.5rem;">YOU ARE IN LINE</div>
                <div style="font-size: 4rem; font-weight: 800; color: var(--primary); line-height: 1;" id="liveWait">--</div>
                <p style="font-weight: 600; color: #64748b; margin-top: 0.5rem;">Estimated Minutes</p>
                <hr style="border: 0; border-top: 1px solid #f1f5f9; margin: 1.5rem 0;">
                <div style="display: flex; justify-content: space-between; padding: 0 10px;">
                    <p style="margin:0; color: #64748b;">Your Position:</p>
                    <p style="margin:0; font-weight: 800; color: var(--primary);" id="livePos">--</p>
                </div>
                <p id="selectedSvcLabel" style="font-size: 0.9rem; color: #1e293b; margin-top: 1rem; font-weight: 600;"></p>
                <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 2rem;">Stay close! We'll notify you when you're next.</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();
        const urlParams = new URLSearchParams(window.location.search);
        const providerId = urlParams.get('id') || urlParams.get('provider');
        let currentBusinessName = "";
        let currentBacklog = 0; // Global variable to track total time of people ahead

        window.onload = () => {
            if (!providerId) return showError("No Business ID found.");
            fetchBusinessDetails();
            loadServiceChecklist();
            previewQueue();
        };

        async function fetchBusinessDetails() {
            const doc = await db.collection('providers').doc(providerId).get();
            if (doc.exists) {
                const data = doc.data();
                currentBusinessName = data.businessName;
                document.getElementById('bizName').innerText = currentBusinessName;
                if (data.menuImageUrl) {
                    const img = document.getElementById('menuImgPreview');
                    img.src = data.menuImageUrl;
                    img.style.display = 'block';
                }
            }
        }

        function loadServiceChecklist() {
            const container = document.getElementById('serviceChecklist');
            db.collection('providers').doc(providerId).collection('services').onSnapshot(snap => {
                container.innerHTML = "";
                if (snap.empty) container.innerHTML = "<p style='padding:1rem;'>No services listed.</p>";
                snap.forEach(doc => {
                    const s = doc.data();
                    const item = document.createElement('div');
                    item.className = 'svc-item';
                    item.innerHTML = `
                        <input type="checkbox" name="svc" value="${s.duration}" data-name="${s.name}" onchange="calculateWait()">
                        <div class="svc-info">
                            <span class="svc-name">${s.name}</span>
                            <span class="svc-meta">$${s.price || 0} â€¢ ${s.duration} mins</span>
                        </div>
                    `;
                    item.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            const cb = item.querySelector('input');
                            cb.checked = !cb.checked;
                            calculateWait();
                        }
                    };
                    container.appendChild(item);
                });
            });
        }

        // UPDATED: Calculates wait time based on actual service times of people ahead
        function previewQueue() {
            db.collection('queues')
                .where('providerId', '==', providerId)
                .where('status', '==', 'waiting')
                .onSnapshot(snap => {
                    let totalBacklogTime = 0;
                    
                    // Sum up the service durations of every person currently in line
                    snap.forEach(doc => {
                        const data = doc.data();
                        totalBacklogTime += (Number(data.serviceDuration) || 0);
                    });

                    document.getElementById('aheadCount').innerText = snap.size;
                    currentBacklog = totalBacklogTime; 
                    calculateWait();
                });
        }

        // UPDATED: Wait time only depends on people ahead, not the current selection
        function calculateWait() {
            // The wait time for a new customer is the total time required for all previous visitors
            document.getElementById('estWait').innerText = currentBacklog;
        }

        async function handleCustomerJoin() {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const selectedBoxes = document.querySelectorAll('input[name="svc"]:checked');

            if (selectedBoxes.length === 0) return alert("Please select at least one service.");
            if (!name || !phone) return alert("Please enter your name and phone.");

            const btn = document.getElementById('joinBtn');
            btn.disabled = true;

            try {
                let user = firebase.auth().currentUser;
                if (!user) user = (await firebase.auth().signInAnonymously()).user;

                const selectedSvcNames = Array.from(selectedBoxes).map(cb => cb.dataset.name);
                let myTotalDuration = 0;
                selectedBoxes.forEach(cb => myTotalDuration += Number(cb.value));

                // The estimated time they will be seen is: Current Time + Backlog of others
                const estTimeDate = new Date(Date.now() + currentBacklog * 60000);

                const newDoc = await db.collection('queues').add({
                    userId: user.uid,
                    customerName: name,
                    customerPhone: phone,
                    providerId: providerId,
                    businessName: currentBusinessName,
                    selectedService: selectedSvcNames.join(", "),
                    serviceDuration: myTotalDuration,
                    status: 'waiting',
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    estimatedTime: firebase.firestore.Timestamp.fromDate(estTimeDate)
                });

                startLiveTracking(newDoc.id, selectedSvcNames.join(", "));
            } catch (err) { 
                alert(err.message); 
                btn.disabled = false; 
            }
        }

        function startLiveTracking(myQueueId, svcNames) {
            document.getElementById('joinSection').classList.add('hidden');
            document.getElementById('statusSection').classList.remove('hidden');
            document.getElementById('selectedSvcLabel').innerText = "Services: " + svcNames;

            db.collection('queues')
                .where('providerId', '==', providerId)
                .where('status', '==', 'waiting')
                .orderBy('joinedAt', 'asc')
                .onSnapshot(snap => {
                    const docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const myIndex = docs.findIndex(d => d.id === myQueueId);
                    
                    if (myIndex !== -1) {
                        // Calculate wait for existing session: sum of service times for everyone BEFORE myIndex
                        let waitBeforeMe = 0;
                        for(let i = 0; i < myIndex; i++) {
                            waitBeforeMe += (Number(docs[i].serviceDuration) || 0);
                        }
                        
                        document.getElementById('livePos').innerText = myIndex + 1;
                        document.getElementById('liveWait').innerText = waitBeforeMe;
                    } else {
                        db.collection('queues').doc(myQueueId).get().then(doc => {
                            if(doc.exists && doc.data().status === 'serving') {
                                document.getElementById('statusSection').innerHTML = `
                                    <div style="padding: 2rem;">
                                        <h2 style='color:#166534; font-size: 2rem;'>It's Your Turn!</h2>
                                        <p style="font-size: 1.1rem;">Please head to the counter now.</p>
                                        <button onclick="location.reload()" class="btn">Done</button>
                                    </div>`;
                            }
                        });
                    }
                });
        }

        function showError(msg) {
            const errDiv = document.getElementById('errorMessage');
            errDiv.innerText = msg; 
            errDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
